name: CI/CD - Build, Publish & Deploy (Backend only) # Nom visible dans GitHub Actions

on:
  push:
    branches:
      - main # Déclenche la pipeline à chaque push sur main

permissions:
  contents: read # Autorise la lecture du dépôt
  packages: write # Autorise le push vers GitHub Container Registry (GHCR)

env:
  REGISTRY: ghcr.io # Adresse du registry Docker (GitHub)
  IMAGE_NAME: wish-app-api # Nom de l’image Docker à générer

jobs:
  # --------- JOB 1 : Build + Publish Docker ----------
  build_and_publish:
    runs-on: self-hosted # Le job s'exécute sur TON runner self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # Récupère le code du dépôt

      # ---- Connexion au registry GHCR ----
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }} # ghcr.io
          username: ${{ secrets.GHCR_USERNAME }} #  username GitHub (secret)
          password: ${{ secrets.GHCR_PAT }} # PAT permettant le push (secret)

      # ---- Build de l’image Docker ----
      - name: Build backend Docker image
        run: |
          docker build \                              # Commande de build Docker
            -f Back/wish-app/Dockerfile \             # Chemin vers ton Dockerfile
            -t $REGISTRY/${{ secrets.GHCR_USERNAME }}/$IMAGE_NAME:latest \    # Tag latest
            -t $REGISTRY/${{ secrets.GHCR_USERNAME }}/$IMAGE_NAME:${{ github.sha }} \   # Tag unique par commit
            Back/wish-app                            # Contexte Docker (dossier du backend)

      # ---- Envoi de l’image vers GHCR ----
      - name: Push backend image to GHCR
        run: |
          docker push $REGISTRY/${{ secrets.GHCR_USERNAME }}/$IMAGE_NAME:latest     # Push tag latest
          docker push $REGISTRY/${{ secrets.GHCR_USERNAME }}/$IMAGE_NAME:${{ github.sha }}   # Push tag commit

  # --------- JOB 2 : Déploiement sur serveur de PROD ----------
  deploy:
    runs-on: self-hosted # Exécuté du même runner
    needs: build_and_publish # Ce job attend que le build soit réussi
    steps:
      - name: Vérifier la connexion SSH
        run: ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER_PROD }}@${{ secrets.SSH_HOST_PROD }} "echo 'SSH OK'"
        # Test que la connexion SSH fonctionne

      - name: Déployer le backend sur le serveur de production
        uses: appleboy/ssh-action@v1.1.0 # Action GitHub pour exécuter des commandes SSH
        with:
          host: ${{ secrets.SSH_HOST_PROD }} # IP du serveur
          username: ${{ secrets.SSH_USER_PROD }} # Nom d'utilisateur SSH
          key: ${{ secrets.SSH_PRIVATE_KEY_PROD }} # Clé privée SSH (secret)
          script: |
            echo "==> Connexion à GitHub Container Registry"
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin
            # Le serveur distant se connecte à GHCR pour pull l’image

            echo "==> Téléchargement de la dernière image backend"
            docker pull $REGISTRY/${{ secrets.GHCR_USERNAME }}/$IMAGE_NAME:latest
            # Récupère la nouvelle image Docker

            echo "==> Mise à jour des conteneurs"
            cd ~/Bureau/403-filrouge-TATKOVA-Anastasiia/wishApp   # Va au dossier de production
            docker compose --env-file .env.prod -f docker-compose-prod.yml down    # Stop + supprime conteneurs
            docker compose --env-file .env.prod -f docker-compose-prod.yml up -d   # Relance avec la nouvelle image

            echo "Déploiement backend terminé avec succès."   # Message final
